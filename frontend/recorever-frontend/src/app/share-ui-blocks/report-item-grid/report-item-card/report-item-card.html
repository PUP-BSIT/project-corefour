<mat-card
  class="modern-item-card"
  [class.highlighted-item]="isHighlighted()"
  (click)="onCardClick()">

  <div class="card-media">
    <div class="carousel-viewport">
      <img mat-card-image
           [src]="currentImageUrl()"
           [alt]="report().item_name"
           class="item-image">

      @if (hasMultipleImages()) {
        <button mat-icon-button
                class="carousel-btn carousel-btn--prev"
                (click)="previousImage($event)"
                aria-label="Previous image">
          <mat-icon>chevron_left</mat-icon>
        </button>

        <button mat-icon-button
                class="carousel-btn carousel-btn--next"
                (click)="nextImage($event)"
                aria-label="Next image">
          <mat-icon>chevron_right</mat-icon>
        </button>

        <div class="carousel-indicators">
          @for (url of photoUrls(); track url; let i = $index) {
            <span class="indicator"
                  [class.indicator--active]="currentImageIndex() === i"
                  (click)="$event.stopPropagation(); currentImageIndex.set(i)">
            </span>
          }
        </div>
      }
    </div>

    <div class="status-overlay">
      <app-status-badge [status]="displayStatus()"></app-status-badge>
    </div>

    @if (isOwner() || report().claim_code) {
      <button mat-mini-fab
              class="floating-menu-trigger"
              [matMenuTriggerFor]="cardMenu"
              (click)="$event.stopPropagation()">
        <mat-icon>more_horiz</mat-icon>
      </button>
      <mat-menu #cardMenu="matMenu" xPosition="before">
        @if (report().type !== 'lost' || report().claim_code) {
          <button mat-menu-item (click)="onViewCode($event)">
            <mat-icon>qr_code_2</mat-icon>
            <span>{{ getCodeButtonLabel() }}</span>
          </button>
        }
        @if (isOwner()) {
          <button
            mat-menu-item
            (click)="onEdit($event)"
            [disabled]="!isEditable()"
            [matTooltip]="!isEditable()
                ? 'Verified reports are locked and cannot be edited' : ''"
            matTooltipPosition="left">
            <mat-icon>edit_square</mat-icon>
            <span>Edit Report</span>
          </button>
          <mat-divider></mat-divider>
          <button
            mat-menu-item
            (click)="onDelete($event)"
            [disabled]="!isRemovable()"
            [matTooltip]="removeTooltip()"
            matTooltipPosition="left"
            class="delete-option">
            <mat-icon color="warn">auto_delete</mat-icon>
            <span class="text-danger">Remove</span>
          </button>
        }
      </mat-menu>
    }
  </div>

  <mat-card-content class="card-body">
    <div class="header-meta">
      <span class="poster-identity">{{ userName() }}</span>
      <span class="post-timestamp">{{
          (report().date_posted || report().date_reported) | timeAgo }}</span>
    </div>

    <h3 class="item-title">{{ report().item_name }}</h3>

    <div class="details-group">
      <div class="detail-item">
        <mat-icon>location_on</mat-icon>
        <span class="text">{{ report().location }}</span>
      </div>

      <div class="detail-item highlighted">
        <mat-icon>calendar_today</mat-icon>
        <span class="label">Date {{
            report().type === 'lost' ? 'Lost' : 'Found' }}:</span>
        <span class="value">{{
            (report().date_lost_found ||
            report().date_reported) | date: 'mediumDate' }}</span>
      </div>
    </div>

    <p class="summary">{{ report().description }}</p>
  </mat-card-content>

  <mat-card-actions align="end" class="card-footer">
    @if (isArchiveView()) {
      <button
          mat-button class="unarchive-btn"
          (click)="onUnarchive($event);
          $event.stopPropagation()">
        <mat-icon>unarchive</mat-icon>
        UNARCHIVE
      </button>

    } @else if (report().type === 'lost' && report().expiry_date) {
      <div class="admin-reference-display expiry-highlight">
        <span class="label">EXPIRES:</span>
        <span class="expiry-highlight">
          {{ report().expiry_date | date: 'shortDate' }}</span>
      </div>

    } @else if (report().type === 'found' && !isOwner()) {
      @if (shouldShowCodeAutomatically()) {
        <div class="admin-reference-display">
          <span class="label">REF CODE:</span>
          <span class="code">{{ referenceCodeValue() }}</span>
        </div>
      }

      @else {
        <button
              mat-button class="view-ticket-btn"
              (click)="onTicketClick();
              $event.stopPropagation()">
          CLAIM ITEM
          <mat-icon>keyboard_arrow_right</mat-icon>
        </button>
      }
    }
  </mat-card-actions>
</mat-card>

@if (activeModalMode()) {
  <app-codes-modal
      [title]="modalTitle()"
      [code]="referenceCodeValue()"
      [description]="modalDescription()"
      (close)="onCloseModal()">
  </app-codes-modal>
}