<div class="profile-page">
  <div class="profile-page__header">
    @if (currentUser$ | async; as user) {
      <div class="card-container">
        <div class="profile-content">
          <div class="avatar-wrapper">
            <div class="avatar-circle">
              <img [src]="getUserProfilePicture(user)"
                   alt="Profile Avatar"
                   class="avatar-img">
            </div>
          </div>
          <div class="info-wrapper">
            <h2 class="user-name">{{ user.name }}</h2>
            <div class="details">
              <p class="user-detail email">{{ user.email }}</p>
              <p class="user-detail phone">{{ user.phone_number }}</p>
            </div>
          </div>
        </div>
        <div class="action-buttons">
          @if (isOwnProfile$ | async) {
            <button type="button"
                    class="edit-btn"
                    (click)="showEditModal = true">
              Edit Profile
            </button>
          }
        </div>
      </div>

      @if (showEditModal) {
        <app-edit-profile-modal
            [user]="user"
            [errorMessage]="updateError"
            (close)="showEditModal = false"
            (save)="handleSaveProfile($event)">
        </app-edit-profile-modal>
      }
    }
  </div>

  <div class="profile-page__controls">
    <div class="profile-page__tabs">
      <button type="button"
          class="profile-page__tab-btn"
          [class.profile-page__tab-btn--active]=
              "(activeTab$ | async) === 'all'"
                  (click)="setActiveTab('all')">
        All
      </button>
      <button type="button"
          class="profile-page__tab-btn"
          [class.profile-page__tab-btn--active]=
              "(activeTab$ | async) === 'found'"
                  (click)="setActiveTab('found')">
        Found
      </button>
      <button type="button"
          class="profile-page__tab-btn"
          [class.profile-page__tab-btn--active]=
              "((activeTab$ | async) === 'lost')"
                  (click)="setActiveTab('lost')">
        Lost
      </button>
    </div>

    <div class="profile-page__filter">
      @if (activeStatus$ | async) {
        <button type="button"
            class="clear-filter-btn"
            (click)="clearStatusFilter()">
          Clear filters
        </button>
      }

      <div class="dropdown-wrapper">
        <select #statusSelect
            class="status-dropdown"
            [value]="activeStatus$ | async"
            (change)="setActiveStatus(statusSelect.value)">
          <option value="" disabled selected hidden>Status</option>
          
          @if (isOwnProfile$ | async) {
            <option value="pending">Pending</option>
          }
          
          <option value="approved">Verified</option>
          <option value="claimed">Claimed</option>
          <option value="resolved">Resolved</option>
        </select>
        <img src="assets/arrow-right.png" class="dropdown-arrow" alt="arrow">
      </div>
    </div>
  </div>

  <div class="profile-page__content">
    @if (displayedItems().length > 0) {
      <app-report-item-grid
          [items]="displayedItems()"
          [currentUserId]="(loggedInUser$ | async)?.user_id ?? null"
          [isUserProfilePage]="(isOwnProfile$ | async) ?? false"
          (cardClicked)="onCardClick($event)"
          (cardDeleteClicked)="onDeleteItem($event)"
          (cardEditClicked)="onEditItem($event)"
          (cardViewCodeClicked)="onViewCode($event)">
      </app-report-item-grid>
    }

    <div #scrollAnchor class="scroll-anchor">
      @if (isItemsLoading()) {
         <div class="profile-page__empty">
            <div class="spinner"></div>
            <p>Loading items...</p>
         </div>
      } @else if (displayedItems().length === 0) {
        <div class="profile-page__empty">
          <p>No items found.</p>
        </div>
      } @else if (currentPage() >= totalPages()) {
        <div class="profile-page__empty">
          <p class="empty-hint">You've reached the end of your reports.</p>
        </div>
      }
    </div>
  </div>

  @if (showDeleteModal) {
    <app-delete-report-modal
        (confirm)="confirmDelete()"
        (cancel)="cancelDelete()">
    </app-delete-report-modal>
  }

  @if (viewCodeItem()) {
    <app-codes-modal
        [title]="codeModalTitle()"
        [code]="codeModalValue()"
        (close)="viewCodeItem.set(null)">
    </app-codes-modal>
  }

  @if (selectedItem(); as item) {
    @if (loggedInUser$ | async; as loggedInUser) {
      <app-item-detail-modal
          [item]="item"
          [currentUserId]="loggedInUser.user_id"
          [userProfilePicture]="item.reporter_profile_picture ?? null" 
          (close)="selectedItem.set(null)"
          (editClicked)="onModalEdit()"
          (deleteClicked)="onModalDelete()"
          (viewCodeClicked)="onModalViewCode()">
      </app-item-detail-modal>
    }
  }
</div>