<div class="modal-overlay" (click)="onClose()">
  <div class="modal-container"
      (click)="$event.stopPropagation(); closeDropdown()">

    @if (isArchiveView() || isAdmin()) {
      <button class="close-btn" (click)="onClose()">
        <mat-icon>close</mat-icon>
      </button>
    }

    <div class="modal-content">
      <div class="modal-header">
        <div class="user-info clickable-profile" (click)="navigateToProfile()">
          <div class="avatar-circle">
            <img
                [src]="getUserProfilePicture()"
                [alt]="getUserName()"
                class="avatar-img">
          </div>
          <div class="user-details">
            <span class="username">{{ getUserName() }}</span>
            <span class="timestamp">{{ (item().date_posted ||
                item().date_reported) | timeAgo }}</span>
          </div>
        </div>
        <div class="header-actions">
          <app-status-badge [status]="displayStatus()"></app-status-badge>

          @if (isOwner() || item().claim_code) {
            <button mat-icon-button
                    [matMenuTriggerFor]="modalMenu"
                    class="modal-menu-trigger">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #modalMenu="matMenu" xPosition="before">
              @if (item().type !== 'lost' || item().claim_code) {
                <button mat-menu-item (click)="onViewCode($event)">
                  <mat-icon>tag</mat-icon>
                  <span>{{ getCodeButtonLabel() }}</span>
                </button>
              }
              @if (isOwner()) {
                <button
                  mat-menu-item
                  (click)="onEdit($event)"
                  [disabled]="!isEditable()"
                  [matTooltip]="!isEditable()
                      ? 'Verified reports are locked and cannot be edited' : ''"
                  matTooltipPosition="left">
                  <mat-icon>edit_square</mat-icon>
                  <span>Edit Report</span>
                </button>
                <mat-divider></mat-divider>
                <button
                  mat-menu-item
                  (click)="onDelete($event)"
                  [disabled]="!isRemovable()"
                  [matTooltip]="removeTooltip()"
                  matTooltipPosition="left"
                  class="delete-option">
                  <mat-icon color="warn">auto_delete</mat-icon>
                  <span class="text-danger">Remove</span>
                </button>
              }
            </mat-menu>
          }
        </div>
      </div>

      <div class="image-section">
        <div class="carousel-container">
          <img [src]="currentImageUrl()"
               [alt]="item().item_name"
               class="modal-image">

          @if (hasMultipleImages()) {
            <button mat-icon-button
                    class="carousel-btn carousel-btn--prev"
                    (click)="previousImage($event)">
              <mat-icon>chevron_left</mat-icon>
            </button>

            <button mat-icon-button
                    class="carousel-btn carousel-btn--next"
                    (click)="nextImage($event)">
              <mat-icon>chevron_right</mat-icon>
            </button>

            <div class="carousel-indicators">
              @for (url of photoUrls(); track url; let i = $index) {
                <span class="indicator"
                      [class.indicator--active]="currentImageIndex() === i"
                      (click)="$event.stopPropagation();
                          currentImageIndex.set(i)">
                </span>
              }
            </div>
          }
        </div>
      </div>

      <div class="details-section">
        <h2 class="item-title">{{ item().item_name }}</h2>

        @if (item().expiry_date && (isOwner() )) {
          <div class="detail-row expiry-warning">
            <mat-icon color="warn">event_busy</mat-icon>
            <span class="detail-label">Report Expiry:</span>
            <span class="detail-value text-danger">
              {{ item().expiry_date | date: 'mediumDate' }}</span>
          </div>
        }

        <div class="detail-row">
          <mat-icon>label</mat-icon>
          <span class="detail-label">Type:</span>
          <span class="detail-value">{{ item().type === 'lost' ?
              'Lost Item' : 'Found Item' }}</span>
        </div>

        <div class="detail-row">
          <mat-icon>location_on</mat-icon>
          <span class="detail-label">Location:</span>
          <span class="detail-value">{{ item().location }}</span>
        </div>

        <div class="detail-row">
          <mat-icon>calendar_today</mat-icon>
          <span class="detail-label">Date {{ item().type === 'lost' ?
              'Lost' : 'Found' }}:</span>
          <span class="detail-value">{{ (item().date_lost_found ||
              item().date_reported) | date: 'mediumDate' }}</span>
        </div>

        <div class="description-section">
          <h3>Description</h3>
          <p>{{ item().description }}</p>
        </div>

        @if (item().remarks) {
          <div class="remarks-section">
            <h3>Remarks</h3>
            <p>{{ item().remarks }}</p>
          </div>
        }
      </div>

      <div class="modal-actions">
        @if (isArchiveView()) {
          <button mat-raised-button
                  class="action-btn action-btn--unarchive status-btn--matched"
                  (click)="onUnarchive()">
            <mat-icon>unarchive</mat-icon>
            UNARCHIVE
          </button>
        }
        @else {
          @if (item().type === 'found' && !isOwner() && !isAdmin()) {
            <button mat-raised-button
                    color="primary"
                    class="action-btn"
                    (click)="onViewTicket()">
              CLAIM ITEM
            </button>
          }
        }

        @if (isAdmin() && !isArchiveView()) {
          <div class="status-dropdown-wrapper" style="flex: 1;">
            <button
                class="status-btn"
                [ngClass]="(item().status || 'pending').toLowerCase()"
                (click)="toggleDropdown($event)">
                {{ (item().status === 'approved' || item().status === 'matched' 
                    ? 'Verified' 
                    : item().status) | titlecase }}
              <span class="arrow">â–¼</span>
            </button>

            @if (isDropdownOpen()) {
              <div class="dropdown-content" (click)="$event.stopPropagation()">
                @for (option of STATUS_OPTIONS; track option.value) {
                  @if (option.value !== (item().status || 'pending').toLowerCase() && 
                      !(option.label === 'Verified' && displayStatus() === 'Verified')) {
                    <div
                      [class.disabled-option]="isStatusDisabled(option.value)"
                      [matTooltip]="getOptionTooltip(option.value)"
                      matTooltipPosition="left"
                      (click)="onStatusOptionClick(option.value)">
                      {{ option.label }}
                    </div>
                  }
                }
              </div>
            }
          </div>
        }

        @if (!isArchiveView() && !isAdmin()) {
          <button mat-stroked-button
                  class="action-btn"
                  (click)="onClose()">
            Close
          </button>
        }
      </div>
    </div>
  </div>
</div>

@if (showClaimModal) {
  <app-codes-modal
      title="Item Reference Details"
      [code]="referenceCodeValue()"
      description="To claim this item, please present this code to the
                administrator. You will be asked to provide proof of ownership
                (e.g., describing the contents or showing an ID)"
      (close)="showClaimModal = false">
  </app-codes-modal>
}